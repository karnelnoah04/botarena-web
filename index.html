<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BotArena</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}
.app {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
.header {
  text-align: center;
  margin-bottom: 20px;
}
.title {
  font-size: 28px;
  font-weight: 800;
  background: linear-gradient(90deg,#38bdf8,#818cf8);
  -webkit-background-clip: text;
  color: transparent;
}
.card {
  background: #020617;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid #1e293b;
}
.points {
  font-size: 36px;
  font-weight: bold;
  text-align: center;
  color: #facc15;
}
.task {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #1e293b;
}
.task:last-child { border-bottom: none; }
button {
  background: linear-gradient(90deg,#22c55e,#16a34a);
  border: none;
  color: #022c22;
  padding: 6px 12px;
  border-radius: 999px;
  font-weight: bold;
  cursor: pointer;
}
button:disabled {
  background: #334155;
  color: #94a3b8;
  cursor: default;
}
.footer {
  text-align: center;
  font-size: 12px;
  color: #64748b;
  margin-top: 20px;
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="title">BotArena</div>
    <div id="username">@user</div>
  </div>

  <div class="card">
    <div class="points" id="points">0</div>
    <div style="text-align:center">POINTS</div>
  </div>

  <div class="card">
    <h3>Tasks</h3>
    <div id="taskList">Loading...</div>
  </div>

  <div class="footer">
    Powered by BotArena
  </div>

</div>

<script>
/* ========== CONFIG ========== */
const SUPABASE_URL = "https://jbbgsqvlnlaiabzhrmfp.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_eld7FfHsQi48L9xS513QRQ_mi3iNmBQ";
/* ============================ */

const tg = window.Telegram.WebApp;
tg.ready();

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const telegramId = tg.initDataUnsafe?.user?.id || 0;
const username = tg.initDataUnsafe?.user?.username || "guest";

document.getElementById("username").innerText = "@" + username;

/* ===== LOAD USER ===== */
async function loadUser() {
  const { data } = await supabase
    .from("botarena")
    .select("*")
    .eq("telegram_id", telegramId)
    .single();

  if (!data) {
    await supabase.from("botarena").insert({
      telegram_id: telegramId,
      username: username,
      points: 0
    });
    document.getElementById("points").innerText = 0;
  } else {
    document.getElementById("points").innerText = data.points || 0;
  }
}

/* ===== LOAD TASKS ===== */
async function loadTasks() {
  const list = document.getElementById("taskList");
  list.innerHTML = "Loading...";

  const { data: tasks, error } = await supabase
    .from("tasks")
    .select("*")
    .eq("is_active", true);

  if (error || !Array.isArray(tasks) || tasks.length === 0) {
    list.innerHTML = "No tasks available";
    return;
  }

  list.innerHTML = "";

  for (const t of tasks) {
    // Check if user already did this task
    const { data: userTask } = await supabase
      .from("user_tasks")
      .select("*")
      .eq("telegram_id", telegramId)
      .eq("task_id", t.id)
      .single();

    let buttonLabel = userTask?.is_done ? "Claim" : "Open Task";

    const row = document.createElement("div");
    row.className = "task";

    row.innerHTML = `
      <div>
        <div>${t.task_name}</div>
        <small>+${t.reward} pts</small>
      </div>
      <button ${userTask?.claimed ? "disabled" : ""} onclick="handleTask(this, ${t.id}, ${t.reward}, '${t.url}', ${userTask?.is_done || false})">
        ${buttonLabel}
      </button>
    `;
    list.appendChild(row);
  }
}

/* ===== HANDLE TASK ===== */
async function handleTask(btn, taskId, reward, url, isDone) {
  if (!isDone) {
    // Open the URL
    if (url) window.open(url, "_blank");
    // Mark task as done
    await supabase.from("user_tasks").upsert({
      telegram_id: telegramId,
      task_id: taskId,
      is_done: true,
      claimed: false
    });
    btn.innerText = "Claim";
  } else {
    // Claim points
    const { data: user } = await supabase
      .from("botarena")
      .select("points")
      .eq("telegram_id", telegramId)
      .single();

    const newPoints = (user?.points || 0) + reward;

    await supabase
      .from("botarena")
      .update({ points: newPoints })
      .eq("telegram_id", telegramId);

    // Mark task as claimed
    await supabase
      .from("user_tasks")
      .update({ claimed: true })
      .eq("telegram_id", telegramId)
      .eq("task_id", taskId);

    document.getElementById("points").innerText = newPoints;
    btn.disabled = true;
  }
}

/* ===== INIT ===== */
loadUser();
loadTasks();
</script>
</body>
</html>